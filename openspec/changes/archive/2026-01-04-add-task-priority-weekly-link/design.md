# 任务优先级和周目标关联设计文档

## Context
项目已经实现了三层级目标管理系统(年度→季度→周),但每日任务与这些目标之间缺少直接关联。同时,所有任务和目标都没有优先级标识,用户难以快速识别重要性。

### 背景
- 现有任务管理系统支持子任务、标签、时间追踪
- 已实现年度、季度、周目标的层级关系和自动进度计算
- 数据存储使用 DataStorage 类(LocalStorage + 服务器备份)
- UI 采用统一的设计语言和主题系统

### 约束
- 必须向后兼容现有数据(所有新字段都是可选的)
- 不能破坏现有的目标进度计算机制
- UI 风格必须与现有组件保持一致
- 性能不能因新字段而显著下降
- 移动端和桌面端都要支持

### 利益相关者
- 用户: 需要更清晰的优先级管理和目标-任务联动
- 开发者: 需要清晰的数据模型和实现路径

## Goals / Non-Goals

### Goals
1. **添加优先级系统**: 为任务和目标添加 P0-P3 优先级标识
2. **建立任务-周目标关联**: 任务可以关联到周目标
3. **视觉化优先级**: 使用颜色和徽章清晰展示优先级
4. **向后兼容**: 旧数据无需迁移即可正常工作
5. **统一体验**: 所有类型的任务和目标使用相同的优先级系统

### Non-Goals
1. **自动进度同步**: 任务完成不自动更新周目标进度(保持简单)
2. **复杂优先级算法**: 不实现动态优先级或 AI 推荐
3. **多重关联**: 任务只能关联一个周目标(不支持多对多)
4. **优先级历史**: 不记录优先级变更历史

## Decisions

### Decision 1: 优先级分级系统
**决策**: 使用 P0/P1/P2/P3 四级优先级系统,加上"无优先级"选项。

**原因**:
- P0-P3 是业界通用的优先级命名
- 四级足够表达重要性差异,不会造成选择困难
- 允许"无优先级"保持向后兼容
- 简洁明了,易于理解

**数据表示**:
```javascript
priority: "P0" | "P1" | "P2" | "P3" | undefined
```

**颜色映射**:
- P0: 红色 (#ef4444) - 最高优先级,紧急重要
- P1: 橙色 (#f97316) - 高优先级,重要
- P2: 蓝色 (#3b82f6) - 中优先级,一般
- P3: 灰色 (#6b7280) - 低优先级,次要
- 无: 不显示徽章

**替代方案考虑**:
- 方案 A: 使用数字 1-5 → 不如 P0-P3 直观
- 方案 B: 使用高/中/低 → 不够精细
- 方案 C: 使用星级 ⭐ → 太主观,不够专业

### Decision 2: 周目标关联机制
**决策**: 在任务数据中添加可选的 `weeklyGoalId` 字段,指向关联的周目标 ID。

**原因**:
- 简单直接的外键关联,易于实现和维护
- 不影响现有任务功能
- 为未来扩展留有空间(如进度同步)

**数据表示**:
```javascript
{
  id: string,
  title: string,
  // ... 现有字段
  priority: "P0"|"P1"|"P2"|"P3"|undefined,
  weeklyGoalId: string|undefined  // 关联的周目标 ID
}
```

**关联规则**:
- 任务只能关联当前周或未来周的周目标
- 删除周目标不会删除关联的任务,只清除 weeklyGoalId
- 任务迁移到其他日期时保持关联关系

**替代方案考虑**:
- 方案 A: 双向关联(周目标也记录任务 ID) → 增加复杂度,容易不一致
- 方案 B: 同时支持关联季度和年度目标 → 过于复杂,用户困惑

### Decision 3: UI 组件设计
**决策**: 创建统一的 PriorityBadge 组件,在所有地方复用。

**原因**:
- 保证视觉一致性
- 易于维护和更新
- 减少代码重复

**组件结构**:
```javascript
<PriorityBadge priority="P0" size="sm" />
```

**显示位置**:
- 任务卡片: 左上角或标题旁边
- 目标卡片: 右上角
- 列表项: 标题前的小徽章

**替代方案考虑**:
- 方案 A: 每个地方独立实现 → 难以维护一致性
- 方案 B: 使用纯 CSS 类 → 不够灵活,难以添加交互

### Decision 4: 优先级筛选和排序
**决策**: 添加优先级筛选器,支持多选;默认排序为优先级降序 + 创建时间。

**原因**:
- 提升用户快速找到重要任务的效率
- 多选筛选更灵活(如只看 P0 和 P1)
- 默认排序符合用户直觉

**筛选 UI**:
- 位置: 任务列表顶部或侧边栏
- 样式: 芯片式多选按钮(类似标签筛选)
- 交互: 点击切换选中/未选中

**排序规则**:
1. 未完成任务优先
2. 优先级高的在前(P0 > P1 > P2 > P3 > 无)
3. 相同优先级按创建时间降序

### Decision 5: 数据迁移策略
**决策**: 不需要显式迁移,所有新字段默认为 undefined,旧代码继续工作。

**原因**:
- 最小化实现复杂度
- 零停机时间
- 用户可以逐步添加优先级,不强制

**兼容性处理**:
```javascript
// 读取时
const priority = task.priority || undefined;
const weeklyGoalId = task.weeklyGoalId || undefined;

// 显示时
{task.priority && <PriorityBadge priority={task.priority} />}
```

## Risks / Trade-offs

### Risk 1: UI 空间拥挤
**风险**: 添加优先级徽章和周目标关联可能让任务卡片过于拥挤。

**缓解措施**:
- 使用小巧的徽章设计
- 优先级徽章可折叠(仅在悬停时显示详情)
- 周目标关联使用小图标指示器
- 移动端优先级徽章放在标题行内联

### Risk 2: 用户滥用优先级
**风险**: 用户可能将所有任务标记为 P0,失去优先级的意义。

**缓解措施**:
- 提供优先级使用指南(首次使用提示)
- 在 UI 中显示各优先级的任务统计
- 建议 P0 任务不超过 3 个的最佳实践

### Risk 3: 周目标关联的维护成本
**风险**: 周目标删除或修改时,关联的任务需要处理。

**缓解措施**:
- 删除周目标时只清除关联,不删除任务
- 在任务列表中显示"关联的目标已删除"提示
- 提供批量清除无效关联的工具

### Trade-off 1: 简单性 vs 功能性
**取舍**: 不实现任务完成自动更新周目标进度。

**原因**:
- 保持简单,避免复杂的进度计算逻辑
- 用户仍需手动更新周目标进度
- 未来可以作为独立功能添加

## Migration Plan
本次变更不需要数据迁移,但需要以下步骤:

### 阶段 1: 数据模型和后端(无用户影响)
1. 更新数据类型定义
2. 更新 storage.js 的合并逻辑
3. 验证数据持久化

### 阶段 2: UI 组件(逐步发布)
1. 创建 PriorityBadge 组件
2. 更新任务创建模态框
3. 更新任务列表显示
4. 更新目标追踪器

### 阶段 3: 功能完善
1. 添加优先级筛选
2. 添加周目标关联选择器
3. 完善交互体验

### 回滚计划
- 移除 UI 中的优先级选择器和徽章
- 旧数据仍然有效,无需清理

## Open Questions
1. **是否需要优先级变更通知?** 
   - 初期不实现,观察用户需求
   
2. **是否支持批量设置优先级?**
   - 暂不支持,保持简单
   
3. **习惯是否需要优先级?**
   - 初期支持,使用与任务相同的系统
   
4. **优先级是否影响排序权重?**
   - 是,默认排序考虑优先级

